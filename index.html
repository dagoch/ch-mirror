<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
		<!--script type="text/javascript" src="website/js/jquery.js"></script-->
			<script type="text/javascript" src="website/js/color-thief.js"></script>
			<script type="text/javascript" src="website/js/quantize.js"></script>
      <script src="website/js/jquery.ripples.js"></script>
		<script type="text/javascript" src="website/js/ch-mirror.js"></script>


		<link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>

		<title>CH-Mirror</title>
	</head>
	<body>
	Demo: blow into the microphone to retrieve an image from the Cooper Hewitt collection.<p/>


<div id="hiddencamera" style="display:none;">
<video autoplay muted></video>
</div>
<canvas id="camera-canvas" style="display:none;" width=640 height=480></canvas>


		<div id="container">


	<div id="art_info" style="display: none;"></div>
	<div id="loading" style="display: none;"><p>Getting Art<br/> <img src="ajax-loader.gif"></p></div>
	<div id="art">
</div>
</div>

<script>
var startRipples = function() {
  console.log("Starting ripples!");
$('#art').ripples({
  resolution: 256,
  dropRadius: 20,
  perturbance: 0.04,
});
     //$('body').ripples("play");
  // Automatic drops
  setInterval(function() {
    var $el = $('#art');
    var x = Math.random() * $el.outerWidth();
    var y = Math.random() * $el.outerHeight();
    var dropRadius = 20;
    var strength = 0.04 + Math.random() * 0.04;
    
    $el.ripples('drop', x, y, dropRadius, strength);
  }, 400);
};

function hasGetUserMedia() {
  return !!(navigator.webkitGetUserMedia || navigator.getUserMedia || 
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

if (hasGetUserMedia()) {
  // Good to go!
} else {
  alert('getUserMedia() is not supported in your browser');
}

  var errorCallback = function(e) {
    console.log('Reeeejected!', e);
  };

    var video = document.querySelector('video');
  var canvas = document.getElementById('camera-canvas'); // document.querySelector('canvas');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;

  function snapshot() {
    if (localMediaStream) {
    	console.log(video.videoWidth+" : "+video.videoHeight);
      ctx.drawImage(video, 0, 0,video.videoWidth,video.videoHeight);
      // "image/webp" works in Chrome.
      // Other browsers will fall back to image/png.
   //   document.querySelector('img').src = canvas.toDataURL('image/webp');
   chMirror(canvas.toDataURL('image/webp'));

   // 

    }
  }

  video.addEventListener('click', snapshot, false);


navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;


if (navigator.getUserMedia) {
  navigator.getUserMedia(
  	{	audio: true, 
  	 	video: true  //{  width: { min: 640, ideal: 1280, max: 1920 },
        			   //    height: { min: 480, ideal: 720, max: 1080 }}
     }, 
    function(stream) {
    		video.src = window.URL.createObjectURL(stream);
        	localMediaStream = stream;

        	var input = audCtx.createMediaStreamSource(stream); // webaudioapi.com/samples/microphone/microphone-sample.js
        	input.connect(analyser);
        	requestAnimationFrame(updateAud);

    // Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
    // See crbug.com/110938.
    video.onloadedmetadata = function(e) {
      // Ready to go. Do some stuff.
    };
  }, errorCallback);
} else {
  video.src = 'somevideo.webm'; // fallback.
}


audCtx = new (window.AudioContext || window.webkitAudioContext)();
var analyser = audCtx.createAnalyser();
analyser.fftSize = 2048;
analyser.smoothingTimeConstant = 0.2;
console.log(".smoothingTimeConstant = "+analyser.smoothingTimeConstant);
var dataArray = new Uint8Array(analyser.frequencyBinCount); // developer.mozilla.org/en-US/docs/Web/API/AnalyserNode
var lastAvgVol = 0;
function updateAud() {
	analyser.getByteFrequencyData(dataArray);
	accum = 0;
  cntbins = 0;
	for (i=0; i<dataArray.length;i++) {
		accum += dataArray[i];
    if ((lastAvgVol > 0) && (dataArray[i]-lastAvgVol>20)) cntbins++; // count number of loud bins 
	}
	avg = accum/dataArray.length;
  //console.log("Avg freq = "+avg+ " lastAvgVol = "+lastAvgVol+ " cntbins = "+cntbins);
  lastAvgVol = avg;
  
	if (avg>60) { //(cntbins>300) { //  {


		snapshot();   // if any power peaks over 50, take a snapshot!
//		localStorage["lastsnapshot"]= new Date().getTime(); // store current time in milliseconds
    setTimeout(keepListening, 5000);  // after 20 seconds, start listening for sound again
	} else {	
		requestAnimationFrame(updateAud);
	}
}

function keepListening() {
      requestAnimationFrame(updateAud);
}


</script>


