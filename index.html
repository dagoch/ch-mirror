<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<script type="text/javascript" src="website/js/jquery.js"></script>
			<script type="text/javascript" src="website/js/color-thief.js"></script>
			<script type="text/javascript" src="website/js/quantize.js"></script>
		<script type="text/javascript" src="website/js/ch-mirror.js"></script>
		<link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>

		<title>CH-Mirror</title>
	</head>
	<body>
	Clap your hands to retrieve an image from the Cooper Hewitt collection.<p/>


<div id="hiddencamera" style="display:none;">
<video autoplay></video>
</div>
<canvas style="display:none;" width=640 height=480></canvas>


		<div id="container">


	<div id="art_info" style="display: none;"></div>
	<div id="loading" style="display: none;"><p>Getting Art<br/> <img src="ajax-loader.gif"></p></div>
	<div id="art">
</div>
</div>

<script>
function hasGetUserMedia() {
  return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
            navigator.mozGetUserMedia || navigator.msGetUserMedia);
}

if (hasGetUserMedia()) {
  // Good to go!
} else {
  alert('getUserMedia() is not supported in your browser');
}

  var errorCallback = function(e) {
    console.log('Reeeejected!', e);
  };

    var video = document.querySelector('video');
  var canvas = document.querySelector('canvas');
  var ctx = canvas.getContext('2d');
  var localMediaStream = null;

  function snapshot() {
    if (localMediaStream) {
    	console.log(video.videoWidth+" : "+video.videoHeight);
      ctx.drawImage(video, 0, 0,video.videoWidth,video.videoHeight);
      // "image/webp" works in Chrome.
      // Other browsers will fall back to image/png.
   //   document.querySelector('img').src = canvas.toDataURL('image/webp');
   chMirror(canvas.toDataURL('image/webp'));

   // 

    }
  }

  video.addEventListener('click', snapshot, false);


navigator.getUserMedia  = navigator.getUserMedia ||
                          navigator.webkitGetUserMedia ||
                          navigator.mozGetUserMedia ||
                          navigator.msGetUserMedia;


if (navigator.getUserMedia) {
  navigator.getUserMedia(
  	{	audio: true, 
  	 	video: true  //{  width: { min: 640, ideal: 1280, max: 1920 },
        			   //    height: { min: 480, ideal: 720, max: 1080 }}
     }, 
    function(stream) {
    		video.src = window.URL.createObjectURL(stream);
        	localMediaStream = stream;

        	var input = audCtx.createMediaStreamSource(stream); // webaudioapi.com/samples/microphone/microphone-sample.js
        	input.connect(analyser);
        	requestAnimationFrame(updateAud);

    // Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
    // See crbug.com/110938.
    video.onloadedmetadata = function(e) {
      // Ready to go. Do some stuff.
    };
  }, errorCallback);
} else {
  video.src = 'somevideo.webm'; // fallback.
}


audCtx = new (window.AudioContext || window.webkitAudioContext)();
var analyser = audCtx.createAnalyser();
analyser.fftSize = 2048;
var dataArray = new Uint8Array(analyser.frequencyBinCount); // developer.mozilla.org/en-US/docs/Web/API/AnalyserNode

function updateAud() {
	analyser.getByteFrequencyData(dataArray);
	accum = 0;
	for (i=0; i<dataArray.length;i++) {
		accum += dataArray[i];
	}
	avg = accum/dataArray.length;
	//console.log("Avg freq = "+avg);
	if (avg>60) {
		snapshot();   // if any power peaks over 50, take a snapshot!
		localStorage["lastsnapshot"]= new Date().getTime(); // store current time in milliseconds
		requestAnimationFrame(updateAud);
//		setTimeout('startListening()', 10000); // after 30 seconds listen for sound again
	} else {	
		requestAnimationFrame(updateAud);
	}
}

// function startListening() {
// 	var millis = new Date().getTime();
// 	console.log("Start Listening: "+millis);
// 	console.log("Localstorage: "+localStorage["lastsnapshot"]);
// 	if (localStorage["lastsnapshot"]-millis>10000) {
// 		requestAnimationFrame(updateAud);
// 	} else {
// 		setTimeout('startListening()',10000);
// 	}
// }
</script>


